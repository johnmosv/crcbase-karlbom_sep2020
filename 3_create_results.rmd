---
title: "Karlbom : Create results"
output:
  html_document:
    highlight: pygments
    theme: sandstone
    css: style.css
    toc: true
    code_folding: show
editor_options:
  chunk_output_type: inline
---

**Datum**: `r lubridate::today()`

```{r setup, include=FALSE, message=FALSE, warning=FALSE, echo=FALSE}
library(data.table)
library(dplyr)
library(stringr)
library(glue)
library(janitor)
library(here)
library(scales)
library(ggplot2)
library(lubridate)
library(rlang)
library(epitools) # CI for rate using exact method
library(cmprsk) # CIF and competing risk

source("crcbase_utils/helpers.R")
source("crcbase_utils/crud/setup_project_crud.R")
source("crcbase_utils/crud/read_from_variable_lists.R")
test_for_k()

knitr::opts_chunk$set(
    # root.dir = '~/R/project',
    warning = FALSE,
    message = FALSE,
    warning = FALSE,
    echo = TRUE,
    include = TRUE
)

if (!exists("params")) {
    params <- list(
        project_name = project_name # from .Renviron
    )
}

# init tables to export
export_tables <- list()
```

# Read analysis data

Created in `2_crate_analysisdata()`. Look there for details.

```{r load analysis data}
ad_raw <- read_from_project_derived("analysisdata.csv")

# Remove unwanted columns
ad <- select_analysis_data(ad_raw)
# paste0(colnames(ad), collapse = " | ")
```

### Create factors
```{r add factor}
# exposed
ad[, case := factor(case, levels = c("exposed", "comparators"))]
tabyl(ad, case)
```

## Create variables

Should move to `2_crate_analysisdata`

```{r}

# Age at proceduredate. Cannot find birthdate

# Categorize follow up time


cat_followup <- function(x) {
    cat_numeric(x, cutoffs = c(6, 18, 41, 66))
}

ad[, `:=`(
    sbo_scrcr_fu_cat_m = cat_followup(sbo_scrcr_fu_m),
    sbo_fu_cat_m = cat_followup(sbo_fu_m),
    sbo_surgery_fu_cat_m1 = cat_followup(sbo_surgery_fu_m1),
    sbo_surgery_fu_cat_m2 = cat_followup(sbo_surgery_fu_m2),
    sbo_surgery_scrcr_fy_cat_m = cat_followup(sbo_surgery_scrcr_fu_m)
)]

```

# Results

## Table 1

A lot of table1 will only be available for the exposed population. 
These should probably be seperated into two tables, one containing just the exposed presenting scrcr variables and a second one
also containing comparators presenting variables available for all.

```{r table 1}

table1_fun <- function(data, group = "") {
    setDT(data)

    tabl <- data[,
        .(
            n = .N,
            diagage_mean = mean_sd(diagage),
            diagage_median = median_iqr(diagage),
            women = n_per(female),
            cci_0 = n_per(cci_weighted == 0),
            cci_1 = n_per(cci_weighted == 1),
            cci_2 = n_per(cci_weighted == 2),
            cci_o2 = n_per(cci_weighted > 2),
            cci_weighted_mean = mean_sd(cci_weighted),
            cci_weighted_median = median_iqr(cci_weighted),
            bmi_under_25 = n_per(bmi_cat == "<25"),
            bmi_25_30 = n_per(bmi_cat == "25-30"),
            bmi_over_30 = n_per(bmi_cat == ">=30"),
            bmi_na = n_per(is_na(bmi_cat)),
            education_u9 = n_per(education_cat == "<9"),
            education_9_to_12 = n_per(education_cat == "9-12"),
            education_o12 = n_per(education_cat == ">12"),
            previous_abdominal_surgery = n_per(bs_previous_abd_surgery),
            neoadj_radiotherapy = n_per(bs_neoadj_radio),
            method = "which variable?",
            procedure = "surgery_type",
            st_il_res = n_per(surgery_type == 1),
            st_right_hem = n_per(surgery_type == 2),
            st_trans_res = n_per(surgery_type == 3),
            st_left_hem = n_per(surgery_type == 4),
            st_sigmoid_res = n_per(surgery_type == 5),
            st_total = n_per(surgery_type == 6),
            st_lower_ar = n_per(surgery_type == 7),
            st_rectum_amp = n_per(surgery_type == 8),
            st_hart = n_per(surgery_type == 9),
            st_tem = n_per(surgery_type == 10),
            st_local_ex = n_per(surgery_type == 11),
            st_laparatomi = n_per(surgery_type == 12),
            st_other = n_per(surgery_type == 13),
            st_appendectomy = n_per(surgery_type == 14),
            stoma_resection = n_per(bs_stoma_resection),
            perop_bleed_u150 = n_per(bs_perop_bleed < 150),
            perop_bleed_150_300 = n_per(bs_perop_bleed >= 150 & bs_perop_bleed < 300),
            perop_bleed_o300 = n_per(bs_perop_bleed > 300),
            perop_bleed_na = n_per(is.na(bs_perop_bleed)),
            perop_bleed_median = median_iqr(bs_perop_bleed),
            perop_bleed_mean = mean_sd(bs_perop_bleed),
            reoperation = "after index",
            fascial_dehiscence = "after index",
            al = "after index",
            stage_0 = n_per(stage == 0),
            stage_1 = n_per(stage == 1),
            stage_2 = n_per(stage == 2),
            stage_3 = n_per(stage == 3),
            stage_4 = n_per(stage == 4),
            stage_missing = n_per(is.na(stage)),
            pt_cat1 = n_per(bs_path_t_stage_cat == 1), # 0-3 and 4 is wanted. But contains 1-6
            pt_cat2 = n_per(bs_path_t_stage_cat == 2),
            pt_cat3 = n_per(bs_path_t_stage_cat == 3),
            pt_cat4 = n_per(bs_path_t_stage_cat == 4),
            pt_cat5 = n_per(bs_path_t_stage_cat == 5),
            pt_cat6 = n_per(bs_path_t_stage_cat == 6),
            adjuvant_chemo = n_per(adj_ct),
            indexyear_2007_2010 = n_per(index_year %in% 2007:2010),
            indexyear_2011_2012 = n_per(index_year %in% 2011:2012),
            indexyear_2013_2016 = n_per(index_year %in% 2013:2016),
            other_baseline_char = "",
            minimal_invasive_surgery = n_per(bs_minimal_invasive_surgery),
            convert_to_open = n_per(bs_convert_to_open),
            tumour_location_left_colon = n_per(bs_location_of_tumour == "left"),
            tumour_location_right_colon = n_per(bs_location_of_tumour == "right"),
            tumour_location_rektum = n_per(bs_location_of_tumour == "rektum"),
            tumour_location_undefined = n_per(bs_location_of_tumour == ""), # 9 = undefined
            anastomotic_site_ilecolic = n_per(bs_surgery_type %in% 1:2),
            anastomotic_site_colocolic = n_per(bs_surgery_type %in% 3:5),
            anastomotic_site_coloilorec = n_per(bs_surgery_type %in% 6:7),
            previous_sbo_3m_bf_diagdate = n_per(bs_previous_sbo_3m_before_diagdate),
            previous_abpain_3m_bf_diagdate = n_per(bs_previous_abpain_3m_before_diagdate),
            indexyear_median = median_iqr(index_year),
            # after index date
            relaspe = n_per(!is.na(relapse_date)),
            death = n_per(!is.na(deathdate))
        ),
        by = group
    ]

    tabl <- transpose_dt(tabl)

    return(tabl)
}

```


```{r table1 run}
# Colon resection open etc. Dont know how to define. And should they really be in a table1?
tab1_pop <- table1_fun(ad, group = "case")

table_dt(tab1_pop, caption = "table 1", title_row_names = FALSE)
```


## Validation

For exposed only.

- Estimate sensitivity (true positive/true positive + false negative) of SBO in SCRCR compared to inpatient register.
- Estimate sensitivty of SBO surgery in SCRCR compared to two inpatient algorithms.
- The inpatient register is the gold standard.
- PPV as well (true positive/true positive + false positive)

### Validation of SBO (table2)

For exposed only

```{r validation sbo}

# Sensitivity,
sensitivity <- function(test, gold) {
    true_positives <- sum(truethy(test == TRUE & gold == TRUE))
    all_positives <- sum(truethy(gold == TRUE))
    estimate <- scales::percent(true_positives / all_positives)
    glue("{true_positives}/{all_positives} ({estimate})")
}

ppv <- function(test, gold) {
    true_positives <- sum(truethy(test == TRUE & gold == TRUE))
    false_positives <- sum(truethy(test == TRUE & gold == FALSE))
    estimate <- scales::percent(true_positives / (true_positives + false_positives))
    glue("{true_positives}/{false_positives} ({estimate})")
}

ad[case == "exposed", .(
    n = .N,
    n_sbo_scrcr = n_per(sbo_scrcr),
    n_sbo_patreg = n_per(sbo_patreg),
    sensitivty = sensitivity(sbo_scrcr, sbo_patreg),
    ppv = ppv(sbo_scrcr, sbo_patreg)
), by = "sbo_fu_cat_m"] %>%
    arrange(sbo_fu_cat_m) %>%
    table_dt(caption = "Sensitivity and PPV for SBO in SCRCR compared to patreg")
```

_Conclusion_: Sensitivity of SBO in scrcr is low (when patreg is the gold standard)  

### Validation of SBO surgery (Table 2)

_correspondence?_
For exposed only.

```{r validation sbo surgery}

# Definition 1
ad[case == "exposed", .(
    n = .N,
    n_sbo_sugery_scrcr = n_per(sbo_surgery_scrcr),
    n_sbo_surgery_patreg1 = n_per(sbo_surgery_patreg1),
    sensitivty1 = sensitivity(sbo_surgery_scrcr, sbo_surgery_patreg1),
    ppv1 = ppv(sbo_surgery_scrcr, sbo_surgery_patreg1)
), by = "sbo_surgery_fu_cat_m1"] %>%
    arrange(sbo_surgery_fu_cat_m1) %>%
    table_dt(caption = "Sensitivity and PPV for SBO surgery in SCRCR compared to inpatient algorithm1")

# Definition 2
ad[case == "exposed",
    .(
        n = .N,
        n_sbo_surgery_scrcr = n_per(sbo_surgery_scrcr),
        n_sbo_surgery_patreg2 = n_per(sbo_surgery_patreg2),
        sensitivty2 = sensitivity(sbo_surgery_scrcr, sbo_surgery_patreg2),
        ppv2 = ppv(sbo_surgery_scrcr, sbo_surgery_patreg2)
    ),
    by = "sbo_surgery_fu_cat_m2"
] %>%
    arrange(sbo_surgery_fu_cat_m2) %>%
    table_dt(caption = "Sensitivity and PPV for SBO surgery in SCRCR compared to inpatient algorithm2")
```

_Conclusion_: 

- PPV is 100% for algorithm2 (no false negatives in the SCRCR, they are all found in patreg too). SCRCR does not really add anything.
- Have these definition from patreg been validated elsewhere?

## Kapplan Meier

```{r kapplan meier}
kapplan_meier <- function(data, event_var, fu_var) {

    # Event, 0=alive, 1=event
    event_var <- enquo(event_var)
    fu_var <- enquo(fu_var)

    # Instead of renaming the columns
    data <- data %>% mutate(event = truethy(!!event_var), fu = !!fu_var)

    # the model (set comparators as ref)
    data$case <- relevel(data$case, ref = "comparators")
    fit <- survival::survfit(survival::Surv(fu, event == TRUE) ~ case, data = data)

    p <- survminer::ggsurvplot(
        fit,
        data = data,
        size = 1, # change line size
        censor = FALSE,
        palette =
            c("#c49f0f", "#0869a1"), # custom color palettes
        conf.int = FALSE, # Add confidence interval
        pval = FALSE, # Add p-value
        legend.labs = c("Comparators", "Exposed"), # Change legend labels
        risk.table.height = 0.25, # Useful to change when you have multiple groups
        xlab = "Follow up time (months)",
        risk.table = TRUE, # Add risk table
        risk.table.col = "black",
        risk.table.y.text = FALSE,
        risk.table.y.text.col = FALSE,
        ggtheme = theme_bw()
    ) + ggplot2::ggtitle(as_label(event_var))

    return(p)
}

kapplan_meier(ad, sbo_patreg, sbo_fu_m)
kapplan_meier(ad, sbo_surgery_patreg1, sbo_surgery_fu_m1)
kapplan_meier(ad, sbo_surgery_patreg2, sbo_surgery_fu_m2)
```

## Incidence and HR of SBO

- Crude incidence of SBO for the two groups. 
- Unadjuster HR 
- Should there be any adjustment done?
- Only for Patient register 
- There are a lot of strata for this table (table 3 in the analysis plan). Should they really all be assessed?

```{r incidence of sbo}

incidence_exact <- function(n, pt, dig = 1) {
    inc_table <- epitools::pois.exact(n, pt)
    x_ci(inc_table$rate, inc_table$lower, inc_table$upper, dig = dig)
}

get_hr_ci <- function(data, event_var, fu_var) {

    # Event, 0=alive, 1=event
    event_var <- enquo(event_var)
    fu_var <- enquo(fu_var)

    # Instead of renaming the columns
    data <- data %>% mutate(event = truethy(!!event_var), fu = !!fu_var)

    # the model (set comparators as ref)
    data$case <- relevel(data$case, ref = "comparators")
    cox_model <- survival::coxph(survival::Surv(fu, event == TRUE) ~ case, data = data)
    # print(summary(cox_model))

    # Only return hr (ci)
    tidy_res <- broom::tidy(cox_model, exponentiate = TRUE, conf.int = TRUE)
    hr_ci <- x_ci(tidy_res$estimate, tidy_res$conf.low, tidy_res$conf.high)

    return(hr_ci)
}


inc_hr_row <- function(x, outcome_in, persontime_in, strata = "", hr = TRUE) {
    outcome <- enquo(outcome_in)
    persontime <- enquo(persontime_in)

    if (strata != "") {
        warning("TODO: handle strata")
    }

    incidence_tab <- x %>%
        group_by(case) %>%
        summarise(
            n = sum(truethy(!!outcome)),
            pyk = round(sum(!!persontime) / 12 / 1000, 3),
            # crude_inc = n / pyk,
            ci_exact = incidence_exact(n, pyk)
        )

    setDT(incidence_tab)
    exp <- incidence_tab[case == "exposed"]
    unexp <- incidence_tab[case == "comparators"]
    colnames(exp) <- paste0(colnames(exp), "_exp")
    colnames(unexp) <- paste0(colnames(unexp), "_comp")

    inc_r <- bind_cols(exp, unexp) %>%
        select(-contains("case")) %>%
        tibble::add_column(outcome = as_label(outcome), .before = 1) %>%
        tibble::add_column(strata = strata, .before = 1)

    if (hr) {
        inc_r$hr <- get_hr_ci(x, !!outcome, !!persontime)
    }

    return(inc_r)
}


bind_rows(
    inc_hr_row(ad, sbo_patreg, sbo_fu_m),
    inc_hr_row(ad, sbo_surgery_patreg1, sbo_surgery_fu_m1),
    inc_hr_row(ad, sbo_surgery_patreg2, sbo_surgery_fu_m2)
) %>%
    table_dt(caption = "Crude incidence of SBO and SBO surgery in exposed and unexposed")
```

- Incidence per 1000 person years.
- Incidence CI estimated using the exact method (ref).

## Cumulative Incidence function

Competing risk = 'death'

Cumulative incidence should be assessed at 

```{r cif}
# Competing risk of death taken into account.
# Fine and Gray (cmprsk)
```
